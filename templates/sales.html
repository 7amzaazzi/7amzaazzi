{% extends "base.html" %}

{% block title %}Process Sale - Shop Management System{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Process New Sale</h1>
    <p>Select products and quantities to complete a sale</p>
</div>

<div class="card">
    <div class="card-header">
        <h2>Available Products</h2>
    </div>
    
    <div id="alert-container"></div>
    
    {% if products %}
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Product</th>
                    <th>Price</th>
                    <th>Available Stock</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% for product in products %}
                <tr>
                    <td>
                        <strong>{{ product.name }}</strong>
                        {% if product.description %}
                        <br><small style="color: #6c757d;">{{ product.description }}</small>
                        {% endif %}
                    </td>
                    <td>${{ "%.2f"|format(product.price) }}</td>
                    <td>{{ product.stock_quantity }}</td>
                    <td>
                        <button class="btn btn-success btn-sm" onclick="addToCart({{ product.id }}, '{{ product.name }}', {{ product.price }}, {{ product.stock_quantity }})">
                            Add to Cart
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="empty-state">
        <div class="empty-state-icon">ðŸ“¦</div>
        <p>No products available for sale. Please add products to inventory first.</p>
        <a href="{{ url_for('inventory') }}" class="btn btn-primary">Go to Inventory</a>
    </div>
    {% endif %}
</div>

<div class="card">
    <div class="card-header">
        <h2>Shopping Cart</h2>
        <button class="btn btn-danger btn-sm" onclick="clearCart()">Clear Cart</button>
    </div>
    
    <div id="cart-items">
        <div class="empty-state">
            <div class="empty-state-icon">ðŸ›’</div>
            <p>Cart is empty. Add products to start a sale.</p>
        </div>
    </div>
    
    <div id="cart-summary" style="display: none;">
        <div class="sale-summary">
            <div class="sale-summary-row">
                <span>Subtotal:</span>
                <span id="subtotal">$0.00</span>
            </div>
            <div class="sale-summary-row sale-summary-total">
                <span>Total:</span>
                <span id="total">$0.00</span>
            </div>
        </div>
        <div style="margin-top: 1rem; text-align: right;">
            <button class="btn btn-primary" onclick="completeSale()">Complete Sale</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let cart = [];

function addToCart(productId, productName, price, maxStock) {
    const existingItem = cart.find(item => item.product_id === productId);
    
    if (existingItem) {
        if (existingItem.quantity < maxStock) {
            existingItem.quantity++;
        } else {
            showAlert('Cannot add more. Maximum stock reached.', 'error');
            return;
        }
    } else {
        cart.push({
            product_id: productId,
            name: productName,
            price: price,
            quantity: 1,
            max_stock: maxStock
        });
    }
    
    updateCartDisplay();
}

function removeFromCart(productId) {
    cart = cart.filter(item => item.product_id !== productId);
    updateCartDisplay();
}

function updateQuantity(productId, newQuantity) {
    const item = cart.find(item => item.product_id === productId);
    if (item) {
        const quantity = parseInt(newQuantity);
        if (quantity > 0 && quantity <= item.max_stock) {
            item.quantity = quantity;
            updateCartDisplay();
        } else if (quantity > item.max_stock) {
            showAlert('Quantity exceeds available stock.', 'error');
            updateCartDisplay();
        }
    }
}

function clearCart() {
    if (cart.length === 0) return;
    if (confirm('Are you sure you want to clear the cart?')) {
        cart = [];
        updateCartDisplay();
    }
}

function updateCartDisplay() {
    const cartItemsDiv = document.getElementById('cart-items');
    const cartSummaryDiv = document.getElementById('cart-summary');
    
    if (cart.length === 0) {
        cartItemsDiv.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">ðŸ›’</div>
                <p>Cart is empty. Add products to start a sale.</p>
            </div>
        `;
        cartSummaryDiv.style.display = 'none';
        return;
    }
    
    let html = '';
    let total = 0;
    
    cart.forEach(item => {
        const subtotal = item.price * item.quantity;
        total += subtotal;
        
        html += `
            <div class="sale-item">
                <div class="sale-item-info">
                    <strong>${item.name}</strong><br>
                    <small>$${item.price.toFixed(2)} each</small>
                </div>
                <div class="sale-item-actions">
                    <input type="number" 
                           class="quantity-input" 
                           value="${item.quantity}" 
                           min="1" 
                           max="${item.max_stock}"
                           onchange="updateQuantity(${item.product_id}, this.value)">
                    <span style="min-width: 80px; text-align: right;">$${subtotal.toFixed(2)}</span>
                    <button class="btn btn-danger btn-sm" onclick="removeFromCart(${item.product_id})">Remove</button>
                </div>
            </div>
        `;
    });
    
    cartItemsDiv.innerHTML = html;
    document.getElementById('subtotal').textContent = `$${total.toFixed(2)}`;
    document.getElementById('total').textContent = `$${total.toFixed(2)}`;
    cartSummaryDiv.style.display = 'block';
}

function completeSale() {
    if (cart.length === 0) {
        showAlert('Cart is empty. Add products before completing sale.', 'error');
        return;
    }
    
    const saleData = {
        items: cart.map(item => ({
            product_id: item.product_id,
            quantity: item.quantity
        }))
    };
    
    fetch('/api/sales', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(saleData)
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => {
                throw new Error(err.error || 'Failed to process sale');
            });
        }
        return response.json();
    })
    .then(data => {
        showAlert('Sale completed successfully!', 'success');
        cart = [];
        updateCartDisplay();
        setTimeout(() => {
            window.location.href = '/history';
        }, 1500);
    })
    .catch(error => {
        showAlert('Error: ' + error.message, 'error');
    });
}

function showAlert(message, type) {
    const alertContainer = document.getElementById('alert-container');
    const alertClass = type === 'success' ? 'alert-success' : 'alert-error';
    alertContainer.innerHTML = `<div class="alert ${alertClass}">${message}</div>`;
    setTimeout(() => {
        alertContainer.innerHTML = '';
    }, 3000);
}
</script>
{% endblock %}
